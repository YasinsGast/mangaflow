import { useEffect, useState, useRef } from 'react';
import { Link } from 'react-router-dom';
import { motion, useInView } from 'framer-motion';
import { Book, Heart, Clock, Award, TrendingUp, Star, Eye, Bookmark, ArrowRight, History, Settings, User, LogOut, Menu, Search, BookmarkCheck, Play } from 'lucide-react';
import ParticleSystem from '@/components/ParticleSystem';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import { useFavorites } from '@/hooks/useFavorites';
import { useBookmark } from '@/hooks/useBookmark';

export default function DashboardPage() {
  const { user, signOut } = useAuth();
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [isScrolled, setIsScrolled] = useState(false);
  const [bookmarks, setBookmarks] = useState<any[]>([]);
  const [readingHistory, setReadingHistory] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [favoritesLoading, setFavoritesLoading] = useState(true);
  const [bookmarksLoading, setBookmarksLoading] = useState(true);
  const [favoriteMangas, setFavoriteMangas] = useState<any[]>([]);
  
  // Favorites hook
  const { getFavoriteMangas, favorites } = useFavorites();
  
  // Bookmark hook
  const { getAllBookmarks } = useBookmark();

  // Scroll detection
  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 50);
    };
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Fetch user data
  useEffect(() => {
    const fetchUserData = async () => {
      if (!user) return;
      
      try {
        setLoading(true);
        
        // Fetch bookmarks (placeholder for now)
        // const { data: bookmarkData } = await supabase
        //   .from('bookmarks')
        //   .select('*, mangas(*), chapters(*)')
        //   .eq('user_id', user.id);
        
        // For now, show empty states
        setBookmarks([]);
        setReadingHistory([]);
      } catch (error) {
        console.error('Error fetching user data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchUserData();
  }, [user]);
  
  // Fetch favorites
  useEffect(() => {
    const loadFavorites = async () => {
      setFavoritesLoading(true);
      const mangas = await getFavoriteMangas();
      setFavoriteMangas(mangas);
      setFavoritesLoading(false);
    };
    
    loadFavorites();
  }, [getFavoriteMangas]);
  
  // Fetch bookmarks
  useEffect(() => {
    const loadBookmarks = async () => {
      console.log('[DashboardPage] Loading bookmarks...');
      setBookmarksLoading(true);
      const bookmarksData = await getAllBookmarks();
      console.log('[DashboardPage] Bookmarks loaded:', bookmarksData.length);
      setBookmarks(bookmarksData);
      setBookmarksLoading(false);
    };
    
    loadBookmarks();
  }, [getAllBookmarks]);

  const stats = [
    { label: 'Okunan B√∂l√ºm', value: '0', icon: Book, color: 'from-blue-500 to-cyan-500', bgColor: 'bg-blue-500/10' },
    { label: 'Favoriler', value: favorites.length.toString(), icon: Heart, color: 'from-pink-500 to-rose-500', bgColor: 'bg-pink-500/10' },
    { label: 'Devam Eden', value: bookmarks.length.toString(), icon: Bookmark, color: 'from-purple-500 to-violet-500', bgColor: 'bg-purple-500/10' },
    { label: 'Toplam S√ºre', value: '0s', icon: Clock, color: 'from-orange-500 to-amber-500', bgColor: 'bg-orange-500/10' },
  ];

  const navItems = [
    { label: 'Ana Sayfa', path: '/' },
    { label: 'Manga/Webtoon', path: '/library' },
    { label: 'Rastgele', path: '/random' },
    { label: 'Kategoriler', path: '/categories' },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900">
      {/* Particle Background */}
      <div className="fixed inset-0 pointer-events-none">
        <ParticleSystem />
      </div>

      {/* Navigation Bar */}
      <motion.nav
        className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${
          isScrolled 
            ? 'backdrop-blur-xl bg-slate-900/80 shadow-lg shadow-purple-500/10' 
            : 'bg-transparent'
        }`}
        initial={{ y: -100, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ duration: 0.6, ease: 'easeOut' }}
        style={{
          borderBottom: isScrolled ? '1px solid rgba(139, 92, 246, 0.2)' : 'none',
        }}
      >
        <div className="container mx-auto px-6">
          <div className="flex items-center justify-between h-20">
            
            {/* Logo/Brand */}
            <Link to="/" className="flex items-center gap-2 group">
              <motion.div
                className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center"
                whileHover={{ scale: 1.05, rotate: 5 }}
                whileTap={{ scale: 0.95 }}
              >
                <Book className="h-6 w-6 text-white" />
              </motion.div>
              <span className="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                MangaFlow
              </span>
            </Link>

            {/* Navigation Links - Desktop */}
            <div className="hidden md:flex items-center gap-8">
              {navItems.map((item) => (
                <Link key={item.path} to={item.path}>
                  <motion.span
                    className="text-slate-300 hover:text-white font-medium relative group cursor-pointer"
                    whileHover={{ y: -2 }}
                    transition={{ duration: 0.2 }}
                  >
                    {item.label}
                    <motion.span className="absolute bottom-0 left-0 w-0 h-0.5 bg-gradient-to-r from-blue-400 to-purple-400 group-hover:w-full transition-all duration-300" />
                  </motion.span>
                </Link>
              ))}
            </div>

            {/* Right Actions */}
            <div className="flex items-center gap-4">
              <motion.button
                className="p-2 rounded-lg hover:bg-white/10 transition-colors"
                whileHover={{ scale: 1.1 }}
                whileTap={{ scale: 0.9 }}
              >
                <Search className="h-5 w-5 text-slate-300" />
              </motion.button>

              {user && (
                <div className="relative">
                  <motion.button
                    onClick={() => setShowUserMenu(!showUserMenu)}
                    className="p-2 rounded-lg hover:bg-white/10 transition-colors"
                    whileHover={{ scale: 1.1 }}
                    whileTap={{ scale: 0.9 }}
                  >
                    <User className="h-5 w-5 text-slate-300" />
                  </motion.button>

                  {showUserMenu && (
                    <motion.div
                      initial={{ opacity: 0, y: -10 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: -10 }}
                      className="absolute right-0 mt-2 w-48 backdrop-blur-md rounded-xl shadow-lg border border-purple-500/20 overflow-hidden"
                      style={{
                        background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1))',
                      }}
                    >
                      <div className="px-4 py-3 border-b border-purple-500/20">
                        <p className="text-sm text-gray-400">Giri≈ü Yapƒ±ldƒ±</p>
                        <p className="text-sm font-medium text-white truncate">{user.email}</p>
                      </div>
                      
                      <div className="py-2">
                        <Link
                          to="/dashboard"
                          className="flex items-center gap-2 px-4 py-2 text-gray-300 hover:bg-white/10 transition-colors"
                        >
                          <User className="h-4 w-4" />
                          <span>Profilim</span>
                        </Link>
                        
                        <Link
                          to="/settings"
                          className="flex items-center gap-2 px-4 py-2 text-gray-300 hover:bg-white/10 transition-colors"
                        >
                          <Settings className="h-4 w-4" />
                          <span>Ayarlar</span>
                        </Link>
                        
                        <button
                          onClick={async () => {
                            await signOut();
                            setShowUserMenu(false);
                          }}
                          className="w-full flex items-center gap-2 px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors"
                        >
                          <LogOut className="h-4 w-4" />
                          <span>√áƒ±kƒ±≈ü Yap</span>
                        </button>
                      </div>
                    </motion.div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      </motion.nav>

      {/* Main Content */}
      <div className="relative z-10 container mx-auto px-6 pt-32 pb-16 max-w-7xl">
        
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-12"
        >
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 bg-clip-text text-transparent mb-3">
            Profilim
          </h1>
          <p className="text-gray-400 text-lg">
            Ho≈ü geldin, {user?.email?.split('@')[0] || 'Kullanƒ±cƒ±'}! üëã
          </p>
        </motion.div>

        {/* Stats Grid */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
          {stats.map((stat, idx) => (
            <motion.div
              key={stat.label}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: idx * 0.1 }}
              whileHover={{ scale: 1.05, y: -5 }}
              className="backdrop-blur-md rounded-2xl p-6 border border-purple-500/20 relative overflow-hidden group cursor-pointer"
              style={{
                background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05))',
              }}
            >
              <div className={`absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity ${stat.bgColor}`} />
              
              <div className="relative z-10">
                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${stat.color} flex items-center justify-center mb-4`}>
                  <stat.icon className="h-6 w-6 text-white" />
                </div>
                <p className="text-3xl font-bold text-white mb-1">{stat.value}</p>
                <p className="text-sm text-gray-400">{stat.label}</p>
              </div>
            </motion.div>
          ))}
        </div>

        {/* Favorites Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.4 }}
          className="mb-12"
        >
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 to-rose-500 flex items-center justify-center">
                <Heart className="h-5 w-5 text-white" />
              </div>
              <h2 className="text-2xl font-bold text-white">Favorilerim</h2>
            </div>
            {favoriteMangas.length > 0 && (
              <Link to="/library">
                <motion.button
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                  className="flex items-center gap-2 text-purple-400 hover:text-purple-300 transition-colors"
                >
                  <span>T√ºm√ºn√º G√∂r</span>
                  <ArrowRight className="h-4 w-4" />
                </motion.button>
              </Link>
            )}
          </div>

          {favoritesLoading ? (
            <div className="backdrop-blur-md rounded-2xl p-8 border border-purple-500/20 text-center"
              style={{
                background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05))',
              }}
            >
              <p className="text-gray-400 text-lg">Y√ºkleniyor...</p>
            </div>
          ) : favoriteMangas.length > 0 ? (
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
              {favoriteMangas.slice(0, 6).map((manga, idx) => (
                <FavoriteMangaCard key={manga.id} manga={manga} index={idx} />
              ))}
            </div>
          ) : (
            <div className="backdrop-blur-md rounded-2xl p-8 border border-purple-500/20 text-center"
              style={{
                background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05))',
              }}
            >
              <Heart className="h-16 w-16 mx-auto mb-4 text-gray-600" />
              <p className="text-gray-400 text-lg mb-2">Hen√ºz favori manga eklemediniz</p>
              <p className="text-gray-500 text-sm mb-6">Sevdiƒüiniz mangalarƒ± favorilere ekleyerek buradan kolayca ula≈üabilirsiniz</p>
              <Link to="/library">
                <motion.button
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                  className="px-6 py-3 bg-gradient-to-r from-pink-600 to-rose-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-pink-500/50 transition-all"
                >
                  Manga Ke≈üfet
                </motion.button>
              </Link>
            </div>
          )}
        </motion.div>

        {/* Bookmarks Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.5 }}
          className="mb-12"
        >
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-violet-500 flex items-center justify-center">
                <Bookmark className="h-5 w-5 text-white" />
              </div>
              <h2 className="text-2xl font-bold text-white">Devam Eden Okumalarƒ±m</h2>
            </div>
          </div>

          {bookmarksLoading ? (
            <div className="backdrop-blur-md rounded-2xl p-8 border border-purple-500/20 text-center"
              style={{
                background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05))',
              }}
            >
              <p className="text-gray-400 text-lg">Y√ºkleniyor...</p>
            </div>
          ) : (
            <div>
              {/* DEBUG INFO */}
              <div className="bg-red-900/50 p-4 rounded-lg mb-4 text-white text-sm">
                <p>DEBUG: Bookmarks count: {bookmarks.length}</p>
                <p>DEBUG: Bookmarks loading: {bookmarksLoading ? 'true' : 'false'}</p>
                <p>DEBUG: Bookmarks data: {JSON.stringify(bookmarks.slice(0, 1))}</p>
              </div>
              
              {bookmarks.length > 0 ? (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                  {bookmarks.map((bookmark, idx) => (
                    <BookmarkCard key={bookmark.id} bookmark={bookmark} index={idx} />
                  ))}
                </div>
              ) : (
            <div className="backdrop-blur-md rounded-2xl p-8 border border-purple-500/20 text-center"
              style={{
                background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05))',
              }}
            >
              <Bookmark className="h-16 w-16 mx-auto mb-4 text-gray-600" />
              <p className="text-gray-400 text-lg mb-2">Devam eden okumanƒ±z yok</p>
              <p className="text-gray-500 text-sm mb-6">Okumaya ba≈üladƒ±ƒüƒ±nƒ±z mangalar burada g√∂r√ºnecek</p>
              <Link to="/library">
                <motion.button
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                  className="px-6 py-3 bg-gradient-to-r from-purple-600 to-violet-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-purple-500/50 transition-all"
                >
                  Okumaya Ba≈üla
                </motion.button>
              </Link>
            </div>
          )}
            </div>
        </motion.div>

        {/* Reading History Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
        >
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                <History className="h-5 w-5 text-white" />
              </div>
              <h2 className="text-2xl font-bold text-white">Okuma Ge√ßmi≈üi</h2>
            </div>
          </div>

          <div className="backdrop-blur-md rounded-2xl p-8 border border-purple-500/20 text-center"
            style={{
              background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05))',
            }}
          >
            <History className="h-16 w-16 mx-auto mb-4 text-gray-600" />
            <p className="text-gray-400 text-lg mb-2">Hen√ºz okuma ge√ßmi≈üiniz yok</p>
            <p className="text-gray-500 text-sm">Okuduƒüunuz mangalar burada g√∂r√ºnecek</p>
          </div>
        </motion.div>

      </div>
    </div>
  );
}


// Favorite Manga Card Component
interface FavoriteMangaCardProps {
  manga: any;
  index: number;
}

function FavoriteMangaCard({ manga, index }: FavoriteMangaCardProps) {
  const cardRef = useRef(null);
  const isInView = useInView(cardRef, { once: true, amount: 0.3 });

  return (
    <motion.div
      ref={cardRef}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.4, delay: index * 0.1 }}
    >
      <Link to={`/manga/${manga.slug}`}>
        <motion.div
          className="group relative rounded-xl overflow-hidden cursor-pointer"
          style={{
            background: 'rgba(15, 23, 42, 0.6)',
            backdropFilter: 'blur(12px)',
            border: '1px solid rgba(139, 92, 246, 0.2)',
          }}
          whileHover={{ 
            scale: 1.05,
            borderColor: 'rgba(139, 92, 246, 0.5)',
          }}
          transition={{ duration: 0.3 }}
        >
          {/* Cover Image */}
          <div className="relative aspect-[3/4] overflow-hidden">
            <img
              src={manga.cover_image_url || 'https://images.unsplash.com/photo-1618519764620-7403abdbdfe9?w=400&h=600&fit=crop'}
              alt={manga.title}
              className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
            />
            
            {/* Gradient Overlay */}
            <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent opacity-80 group-hover:opacity-90 transition-opacity duration-300" />
            
            {/* Rating Badge */}
            {manga.rating_average && (
              <div className="absolute top-2 right-2 px-2 py-1 rounded-lg backdrop-blur-md" style={{ background: 'rgba(236, 72, 153, 0.8)', border: '1px solid rgba(236, 72, 153, 0.5)' }}>
                <div className="flex items-center gap-1">
                  <Star className="h-3 w-3 text-yellow-400 fill-yellow-400" />
                  <span className="text-white text-xs font-bold">{manga.rating_average.toFixed(1)}</span>
                </div>
              </div>
            )}
          </div>
          
          {/* Title */}
          <div className="p-3">
            <h3 className="text-white font-semibold text-sm line-clamp-2 group-hover:text-purple-300 transition-colors">
              {manga.title}
            </h3>
            {manga.total_chapters && (
              <p className="text-slate-400 text-xs mt-1">{manga.total_chapters} b√∂l√ºm</p>
            )}
          </div>
        </motion.div>
      </Link>
    </motion.div>
  );
}


// Bookmark Card Component
interface BookmarkCardProps {
  bookmark: any;
  index: number;
}

function BookmarkCard({ bookmark, index }: BookmarkCardProps) {
  console.log('[BookmarkCard] Rendering bookmark:', bookmark);
  
  return (
    <div key={bookmark.id}>
      <Link to={`/read/${bookmark.manga_slug}/${bookmark.chapter_number}?page=${bookmark.page_number}`}>
        <motion.div
          className="group relative rounded-xl overflow-hidden cursor-pointer"
          style={{
            background: 'rgba(15, 23, 42, 0.6)',
            backdropFilter: 'blur(12px)',
            border: '1px solid rgba(139, 92, 246, 0.2)',
          }}
          whileHover={{ 
            scale: 1.05,
            borderColor: 'rgba(59, 130, 246, 0.5)',
          }}
          transition={{ duration: 0.4, delay: index * 0.1 }}
        >
          {/* Cover Image */}
          <div className="relative aspect-[3/4] overflow-hidden">
            <img
              src={bookmark.manga_cover_url || 'https://images.unsplash.com/photo-1618519764620-7403abdbdfe9?w=400&h=600&fit=crop'}
              alt={bookmark.manga_title}
              className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
            />
            
            {/* Gradient Overlay */}
            <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/50 to-transparent opacity-90" />
            
            {/* Continue Badge */}
            <div className="absolute top-2 right-2 px-2 py-1 rounded-lg backdrop-blur-md" style={{ background: 'rgba(16, 185, 129, 0.9)', border: '1px solid rgba(16, 185, 129, 0.5)' }}>
              <div className="flex items-center gap-1">
                <Play className="h-3 w-3 text-white fill-white" />
                <span className="text-white text-xs font-bold">Devam Et</span>
              </div>
            </div>
            
            {/* Progress Info - Bottom */}
            <div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-slate-900 to-transparent">
              <div className="flex items-center gap-1 text-emerald-300 text-xs font-semibold mb-1">
                <BookmarkCheck className="h-3 w-3" />
                <span>B√∂l√ºm {bookmark.chapter_number}</span>
              </div>
              <div className="text-slate-300 text-xs">
                Sayfa {bookmark.page_number}
              </div>
            </div>
          </div>
          
          {/* Title */}
          <div className="p-3">
            <h3 className="text-white font-semibold text-sm line-clamp-2 group-hover:text-blue-300 transition-colors">
              {bookmark.manga_title || 'Bilinmeyen Manga'}
            </h3>
            <p className="text-slate-400 text-xs mt-1">
              {new Date(bookmark.updated_at).toLocaleDateString('tr-TR')}
            </p>
          </div>
        </motion.div>
      </Link>
    </div>
  );
}
